\documentclass[10pt]{amsart}
\usepackage[total={6.5in,9in},centering]{geometry}
\usepackage{amsmath}
\usepackage{graphicx} % for png figures
\usepackage{subcaption} % for subfigures
\usepackage{xfrac} % for sfrac (slanted inline fractions)
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage[yyyymmdd]{datetime}
\renewcommand{\dateseparator}{-}
\usepackage{amsaddr} % addresses up front
%\usepackage{amssymb, amsmath, bm, nameref}
\pagenumbering{gobble} % no page numbers

\newcommand{\SETb}{SET\texttrademark\ } % this one has a space after
\newcommand{\SET}{SET\texttrademark}  % this one has no space, so it can be
                                      % followed by a comma or period

\newcommand{\SETSET}{{\sc setset}}
\newcommand{\SETSETA}{{\sc setset-all}}

\begin{document}


\title[SET Enumeration]{Complete Enumeration of the Game \SETb for up to 12 Cards}
\author[Settergren]{Reuben Settergren}
\email{rjs@jhu.edu}

\thanks{Thanks to Liz McMahon and Gary Gordon of Lafayette College for helpful
  correspondence during the development of this capability, as well as for
  writing the delightful book {\em The Joy of Set} \cite{JOS}.}

\maketitle

\begin{abstract}
For the card game \SET, the exact probabilities of all possible numbers of SETs
can be determined analytically for deals of small numbers of cards, and can be
enumerated exhaustively for somewhat larger numbers. But for 12 cards (the
starting number of cards according to the rules of \SET) combinatorial explosion
has so far prohibited direct enumeration, allowing only estimation of
probabilities by simulation. In this result, massively parallel programming on a
Graphical Processing Unit (GPU) is used to exhaustively enumerate all possible
deals of up to 12 cards, in about 100 hours. In particular, the probability that
an opening deal of 12 \SETb cards does not contain a SET is exactly
$2284535476080/70724320184700 \approx 3.2302\%$.
\end{abstract}

\section{Introduction}
In the card game \SET\cite{SET}, each card depicts 4 attributes, and each
attribute (number, texture, color, shape) has 3 possible values, for a total of
$3^4=81$ cards. A `SET' is defined as a set\footnote{A note on terminology:
  \SETb will refer to the card game, `SET' will refer to a SET according to the
  rules of the game, and 'set' will take its normal mathematical sense of an
  unordered collection. A $k$-set (or for instance 5-set or 12-set) will refer
  to a set of $k$ cards.} of 3 cards for which all attributes are either all the
same, or all different. A fundamentally important fact about SETs is that, for
any two distinct cards, there is a unique third card which completes a SET with
them. To find it, set each attribute of the third card appropriately: if the
first two cards have the attribute the same, set the third the same; if they are
different, set the third card's attribute different.

The card game is equivalent to the finite geometry AG(4,3) (4 dimensions, 3
values); cards are analogous to points, and SETs are lines (sets of collinear
points). And just as (in many [all?] geometries) 3 non-collinear points
determine a plane, a `plane' in \SETb can be built from 3 cards which do not
form a SET, by repeatedly adding cards which form SETs with 2 previous
cards. Closure will be reached at 9 cards, at which point all pairs of cards
will have their SET-mate. The number of SETs in a plane is 12. See \cite{JOS}
for extensive discussion of planes, hyperplanes, and the relationship between
\SETb and affine geometry in general.

Another equivalent formulation is that cards are 4-tuples from the set
$\{0,1,2\}^4$, and a SET is three cards such that their sum is $\equiv (0,0,0,0)
\pmod 3$. Even more briefly, the 4-tuples can be represented by 4-digit numbers
in base 3; the 81-cards in the \SETb deck are represented by ternary numbers
0000, 0001, 0002, 0010, \ldots 2222. For any two cards, their unique SET-mate
can be found by choosing each attribute/digit so that the digit sum is $\equiv 0
(\pmod 3)$.

The rules of \SETb specify that a game begins by dealing 12 cards. As long as no
SET is present, 3 more cards are dealt. So the question naturally arises, what
is the probability that 12 cards have no SET? Or more generally, {\bf What is
  the probability distribution of all possible numbers of SETs that 12 cards may
  contain?} That is the question addressed by this work.

If the initial deal has no SETs, additional cards are dealt (three at a time)
until a SET is found. How far could this process go? It turns out that this
question was answered before the game of \SETb was invented. The affine geometry
analogue of a maximal collection of SET cards with no SET is called a `maximal
cap', and in 1971 it was proven that the size of maximal caps in AG(4,3) is 20
\cite{MAXCAP}. Since the largest possible collection of cards with no SET is 20,
in the vanishingly unlikely case that a game of SET reaches 21 cards, there will
definitely be a SET.  This provides a useful bound for how far to extend
analysis of how many cards contain how many SETs; larger numbers of cards can
never occur in a (well-played) game of \SET.

\section{Previous Results}
A complete enumeration of all 12-card sets must consider $\binom{81}{12} \approx
7\times 10^{13}$ cases. McMahon, Gordon et al note (\cite{JOS} p.~259) that,
even though their computer program can process about 100 million deals per hour,
a complete enumeration would still take 80 years. Enumeration, they note,
``might be feasible with streamlined code and faster machines or parallel
processing.''

Donald Knuth tackled the more specific problem of counting how many deals have 0
SETs. Knuth achieves tremendous speedup over exhaustive enumeration by using
``isomorph rejection'' (i.e. `streamlined code'). Knuth called his program to
find SETless $k$-sets, \SETSET \cite{SETSET}. 

For instance, using the 4-digit ternary representation, the first 1-card deal is
$\{0000\}$. Trivially, that 1-card set does not contain a SET; but more
importantly, every other single-card set also does not contain a set, by
isomorphism with the first one. Because of this isomorphism, \SETSET was able to
reject the other cards along with the first, as an isomorphism group all
together.

\SETSET conducted a depth-first search of all sets of size up to 21, but was
able to prune that search whenever:
\begin{itemize}
\item Adding another card to the previous introduces a SET, or
\item Adding another card forms a set which is isomorphic to a
  previously-accounted for SETless set.
\end{itemize}
In this way, \SETSET was able to count all the SETless sets within
$\Sigma_{k=1}^{21}\binom{81}{k}\approx 2.04\times 10^{19}$ sets, by inspecting
only $5.14\times 10^8$ cases, and avoiding inspection of isomorphic
cases. Running \SETSET on a Core i7 2.7GHz processor takes about four and a half
hours.

The `secret sauce' of \SETSET is in what `isomorphic' means, and how to
determine whether one set is isomorphic to another. Five years later (in an
improved solution called \SETSETA \cite{SETSET-ALL}), Knuth realized he could
expand the sense of the isomorphisms, thus increasing the size of the
isomorphism groups, and decreasing their number, which decreases the number of
cases to consider. For instance, while \SETSET considered 128 isomorphism groups
for sets of size $k=4$, \SETSETA dealt with only 2. In total, \SETSETA dealt
with only 9606 isomorphism groups, and thus had drastically improved speed,
reaching the same answers as \SETSET in just 3m45s (on the same hardware).

For 3 and 4 cards, the only posibilities are 0 SETs, or 1 SET, so a complete
picture can be obtained by subtracting the 0-SET counts from
$\binom{81}{k}$. But with the addition of a 5th card, it becomes possible to
have 0, 1, or 2 SETs. \SETSET counts (as does direct combinatorial analysis)
that there are 22441536 5-sets with 0 SETs, but since \SETSET prunes its search
as soon as a first SET is encountered, it does not divide the remaining
$\binom{81}{5}-22441536=3180060$ 5-sets into how many have 1 SET or 2
SETs. Combinatorial analysis is able to determine that the 3180060 divides up as
3116880 with 1 SET and 63180 with 2 SETs (\cite{JOS}, pp.~56-58). This
combinatorial analysis, however cannot be extended all the way to $k=12$,
because the analysis grows infeasibly complex.

\SETSET's analysis of the 0-SET problem is complete, in that it provides counts
of 0-SET $k$-sets for $k$ up to 21, and \cite{MAXCAP} guarantees that for
$k>=21$ there are no more SETless sets. The numbers of SETless sets for
$k=3\ldots 12$ provide useful benchmarks for verifying this work, giving
confidence in the correctness of the counts for the number of sets with 1 SET, 2
SETs, etc. In particular our enumeration will match the \SETSET result of
2284535476080 SETless 12-sets, which is of interest to \SETb enthusiasts.


\section{Implementation}
This paper picks up the implicit challenge of McMahon and Gordon to code the
12-card enumeration with streamlined code and parallel processing (although not
necessarily faster machines). Source code is available on GitHub \cite{ME}. The
code can be run serially, or in parallel using threads or OpenCL \cite{OPENCL}
kernels. Note that OpenCL can be configured so that its kernels can be
parallelized onto either CPU or GPU resources.

For each set of $k$ cards, all $\binom{k}{3}$ triples need to be checked for
whether they constitute a SET. Knuth notes, ``We will frequently need to find
the third card of a SET, given any two distinct cards $x$ and $y$, so we store
the answers in a precomputed table.''  This is an immense computational savings
compared to 4 sums and 4 modulo 3's for each SET determination, so that practice
was adopted here as well.

Sets of $k$ cards are enumerated according to a combinatorial numbering
system. The forward sense of combinatorial numbering computes, for any
particular $k$-set, where it 'ranks' in the enumeration of all $\binom{81}{k}$
$k$-sets. The inverse process starts with an enumeral number $N$, and 'unranks'
it into the $k$-set which occupies that place in the numbering system. The first
iteration of the program used the unranking algorithm presented in
\cite{WIKI}. In order to unrank a combinatorial number $N$ into $k$ specific
cards, the algorithm requires, for each of the $k$ cards, a number of
comparisons to $\binom{n}{k}$, for $n\le 81, k\le 12$. To avoid $O(k)$
computation each for each binomial coefficient, those values were also
precomputed and stored in a lookup table.

The number of lookups of $\binom{n}{k}$ required to unrank a particular number
$N$ into a $k$-set varies. The fixed number of 81 cards establishes an upper
bound on the possible number of lookups per card being unranked, so the
complexity of this unranking algorithm is $O(k)$. The code was temporarily
instrumented to empirically count the average number of steps, and it was
determined that the constant for this linear complexity (the average number of
$\binom{n}{k}$ lookups for unranking a $k$-set) is $C\approx 45$. (This could be
improved by switching to a binary search of the binomial table, but the need for
non-branching code (see immediately below) obviates this computational approach
anyways.)

Later, a combination-incrementing algorithm was implemented, with no branching
(GPU programs are most efficient if there are no {\tt if} or {\tt while}
statements, because simultaneous kernels execute the same line of code together,
and kernels that take different paths through the code have to wait for each
other). Instead of fully-unranking each combination from its enumeral number, we
reuse the previous combination by incrementing it to the next combination in the
series. Because of the avoidance of branching, the combination-increment
algorithm takes exactly the same number of steps to increment any
combination. The algorithm executes 5 lines of code for each of the $k$ cards in
the combination, so the incrementing algorithm is also $O(k)$. The algorithm is
not 9x faster, however, since the 5 lines are more complex than the simple steps
taken in the above unranking algorithm. Empirically, the speedup from switching
to full unranking to incrementation was 2-3x (even serially).

The goal for this paper was to enumerate 12-card deals, which requires
enumeration of combinations numbered by integers as large as $\binom{81}{12}
\approx 7\times 10^{13}$. For this purpose, an unsigned 64-bit integer
suffices. Fortunately, the latest advances in GPU technology have recently
introduced native capabilty for 64-bit integer types. Also fortuitous is the
fact that, since $2^{64} > \binom{81}{21}$, 64-bit unsigned integers suffice all
the way up to deals of 21 cards (the natural limit for this analysis, since no
game of \SETb can ever need more than 21 cards at once).

This problem is `embarassingly parallel': the processing for any $k$-set, or
consecutive range of $k$-sets, is completely independent, and the inputs and
outputs are both independent and small. The input is merely an enumeral number
(or two numbers defining a range), and the output a small array of accumulators,
counting how many $k$-sets in the range have 0 SETs, 1 SET, \ldots 14 SETs (it
is known that 14 is the maximum number of SETs that can occur in 12 cards
\cite{VINCI}). Each kernel can have its own small array of counters, to avoid
write contention, and the counter arrays can be then quickly summed. Doubling
the available computing resources should halve the processing time.

\section{Results}
The exhaustive enumeration program was run for $3<=k<=12$. The results are
presented in Table \ref{THE_TABLE}. Runtimes are for GPU processing on an
NVIDIA Quadro P4000. Non-rigorous trial and error determined that a decent
setting for the GPU processing was to queue 5000 kernels at a time, each tasked
with enumerating a batch of 10000 $k$-combinations.

The 12-set enumeration took 90.1h=3.75d. The total time for $k=3\ldots 12$ was
104.5h=4.35d. (Because of combinatorial explosion, the 12-card enumeration
consumed the lion's share of processing.) The 12-card processing rate was 218M
deals/second, and the overall rate was 226M/second (slightly higher because for
smaller $k$, the number of triples that need to be checked for each set is
smaller). Single-threaded on a Core i7 2.7GHz CPU, the 12-card enumeration ran
at 842K/s (projected exhaustive enumeration time 972d=2.66y). Thus GPU
processing yielded a 218M/842K$\approx$256x speedup (at least comparing these
specific processors). However, the Quadro P4000 has 1792 cores, so it seems
possible that the GPU processing could be further optimized to obtain a 12-card
enumeration time well under 24 hours. Enumeration for $k=13$ or maybe 14 may
become worthwhile, but combinatorial explosion quickly wins again, as runtimes
increase about 7x for each larger $k$. Perhaps Knuth's isomorphism rejection
technique could be extended to counting not just 0-SET deals, making possible
exhaustive enumeration up to $k=21$ or possibly even $k=81$.

\begin{table}
  \caption{Enumeration Results}\label{THE_TABLE}
  \centering
  \begin{tabular}{r | r r r r r r }
    & \multicolumn{6}{c}{Number of cards} \\
    \hline\hline
    SETs & 3 & 4 & 5 & 6 & 7 & 8   \\
    \hline
0  & 84240 & 1579500 & 22441536 & 247615056 & 2144076480 & 14587567020  \\
1  & 1080 & 84240 & 3116880 & 71772480 & 1137240000 & 12981215520 \\
2  &  &  & 63180 & 5068440 & 184485600 & 3996514080 \\
3  &  &  &  & 84240 & 11372400 & 573168960 \\
4  &  &  &  &  &  & 22744800 \\
5  &  &  &  &  & 42120 & 3032640 \\
6  &  &  &  &  &  &  \\
7  &  &  &  &  &  &  \\
8  &  &  &  &  &  & 10530 \\
\hline
$\binom{81}{N}$ & 85320 & 1663740 & 25621596 & 324540216 & 3477216600 & 32164253550  \\
\hline
seconds & 0.001 & 0.002 & 0.045 & 0.56 & 6.3 & 69 
  \end{tabular}

  \vskip 5mm

  \begin{tabular}{r | r r r r }
    SETs & 9 & 10 & 11 & 12 \\
    \hline
0  & 77541824880 & 318294370368 & 991227481920 & 2284535476080 \\
1  & 108956689920 & 676366666560 & 3091339021680 & 10266579666720 \\
2  & 56941354080 & 557948898000 & 3829696640640 & 18459179294400 \\
3  & 15417548640 & 253318946400 & 2704419900000 & 19278240770880 \\
4  & 1857807900 & 62354111040 & 1144078603200 & 12746054337120 \\
5  & 160729920 & 9176162112 & 306795509280 & 5650817178240 \\
6  & 11119680 & 827405280 & 49231877760 & 1649199670560 \\
7  & & 78848640 & 6382949040 & 330527433600 \\
8  & 758160 & 23882040 & 729349920 & 48500063820 \\
9  &  & 3032640 & 243622080 & 8323838640 \\
10 &  &  & 21228480 & 2091005280 \\
11 &  &  & & 160729920 \\
12 & 1170 & 84240 & 2611440 & 86346000 \\
13 &  &  & 379080 & 21340800 \\
14 &  &  &  & 3032640 \\
\hline
$\binom{81}{N}$ & 260887834350 & 1878392407320 & 12124169174520 & 70724320184700 \\
\hline
seconds & 646 & 5697 & 45298 & 324480
  \end{tabular}
\end{table}


A number of interesting features arise from the full pattern of counts. The
value of 84240 shows up 4 times, 3032640 three times, and 160729920 twice. This
invites questions such as, is there a meaningful bijection between the 9-sets
with 5 SETs, and the 12-sets with 11 SETs? Or is it just a coincidence from
combinatorial reuse of the same prime factors?


There are a number of gaps in the table indicating impossible numbers of SETs
for some set sizes. The first gap shows that 7 cards can have 1, 2, 3, or 5
SETs, but not exactly 4 SETs. Although there are 84240 6-sets with 3 SETs, there
is no way to add a $7^{th}$ card and complete only one more SET.\footnote{And
  yet there are 42120 7-sets with 5 SETs -- is there a meaningful correspondence
  with half of the 84240 6-sets with 3 SETs?}

The gaps in the 9-set enumeration are quite interesting. The 1170 9-sets with 12
SETs are the complete collection of all possible planes (this matches the
analytical result obtained in \cite{JOS}, p.~48). It is possible for 9 cards to
have 8 SETs, as explained by Liz McMahon:\footnote{Co-author of \cite{JOS},
  personal correspondence}
\begin{quote}
If you take a plane [12 SETs] and remove one card, what's left has 8 SETs.  You
can then add another point that doesn't complete any more SETs, and that gives
you the 8 SETs in 9 cards.
\end{quote}
Between 8 and 12 SETs though, no intermediate number of SETs is possible for 9
cards.

Every occurrence of a gap for $k$ cards is followed by a gap in the $k+1$ cards
series that is smaller by one.

\begin{figure}[!htb]
  \center{\includegraphics[width=\textwidth]{cols.png}}
  \caption{\label{FIGROWS} Each curve is one number of SETs (table row); x is
    deal size, y is probability}
\end{figure}

\begin{figure}[!htb]
  \center{\includegraphics[width=\textwidth]{rows.png}}
  \caption{\label{FIGCOLS} Each curve is one deal size (table column); x is
    number of SETs, y is probability}
\end{figure}

Figures \ref{FIGROWS} and \ref{FIGCOLS} graph the tabular data by rows and by
columns, and also demonstrate some interesting features. Both graphs normalize
the tabular data into probabilities (dividing by $\binom{81}{k}$), otherwise
each deal size would have numbers of such different orders of magnitude that the
data would not be visually comparable.

In Figure \ref{FIGROWS}, each curve represents the probability of a certain
number of SETs (one row of the table). The horizontal axis is the number of
cards dealt, and the vertical axis is probability. The curve for 0 SETs starts
at $84240/85320\approx 98.7\%$ for 3 cards, and only decreases as more cards are
dealt. If the graph were extended to a deal size of $k=21$, the 0 SETs curve
would reach $0\%$ exactly, but within this range it decreases at $k=12$ to
$2284535476080/70724320184700\approx 3.23\%$ (the figure of most interest to
players of \SET).

The 1-SET curve shows that the probability of exactly 1 SET increases for a
while, as more cards are dealt; but it peaks at $k=9$, and then falls off as it
becomes more likely that 2 or more SETs will occur. The 2 SET curve peaks at
$k=11$. The 3 SET curve reaches its maximum within this range at $k=12$. It is
not obvious whether it peaks there or continues to rise, but non-exhaustive
random sampling simulation would determine that pretty quickly.

(Some of the interesting smaller probabilities cannot be discerned from this
linear scale graph, TBD log scale graph shows more interesting features.)

Figure \ref{FIGCOLS} graphs each column of the table as one curve. The
horizontal axis is number of SETS, and the vertical axis is again
probability. The curves for $k=3$ (highest on the left) and $k=4$ have only two
datapoints each, since the only possibilities for those cases are 0 SETs or 1
SET. $k=5$ introduces the possibility of two SETs, and thus a third data
point. $k=9$ is the smallest deal size for which 0 SETs is not the most likely
outcome. For $k=12$ (of interest to players of \SET), the most likely
occurrences are 3 SETs (27.25\%), and 2 SETs (26.10\%), together accounting for
a small majority of 12-card deals.

(Interesting smaller probabilities shown in log graph, as well as removing
points for gaps)



\section{Conclusion}
This paper improves on the speed of enumeration of starting deals for the card
game \SET, to accomplish exhaustive enumeration for up to 12 cards, in a little
over 4 days. As the marginal factor for extra time spent is about 7x for each
additional card, the same hardware and software could enumerate 13, 14, and 15
cards in about 1 month, 7 months, and 4 years, respectively. To reach a complete
analysis at 21 cards, computational power would have to grow by many orders of
magnitude; or an analytical or non-exhaustive enumerative solution would have to
be devised (perhaps along the lines of Donald Knuth's
isomorphism-rejection-based enumerations of the 0-SET problem).



\begin{thebibliography}{9} % 1-digit reference nums


\bibitem{SETSET}Knuth, Donald E., {\sc setset} (1996), Documented programs in
  CWEB, from
  \url{https://www-cs-faculty.stanford.edu/~knuth/programs/setset.w}. Accessed
  \today.

\bibitem{SETSET-ALL}Knuth, Donald E., {\sc setset-all} (2001), Documented
  programs in CWEB, from
  \url{https://www-cs-faculty.stanford.edu/~knuth/programs/setset-all.w}. Accessed
  \today.

\bibitem{JOS} McMahon, Liz, Gary Gordon, et al, 2016. {\em The Joy of SET: The
  Many Mathematical Dimensions of a Seemingly Simple Card Game}, Princeton
  University Press, Princeton NJ.

\bibitem{OPENCL} Open Computing Language (OpenCL), from {\tt
  khronos.org/opencl}, accessed \today.

\bibitem{MAXCAP}Pellegrino, G., 1971. ``Sul massimo ordine delle calotte in
  $S_{4,3}$'' [{\em The maximal order of the shperical cap in $S_{4,3}$}], {\em
  Matematiche} {\bf 25}, pp 149-157.

\bibitem{SET} SET Enterprises, Inc. \url{https://www.setgame.com}

\bibitem{ME}Settergren, Reuben, 2019. \url{https://github.com/RubeRad/SET}
  
\bibitem{VINCI}Vinci, Jim, 2009. ``The maximum number of sets for $n$ cards and
  the total number of internal sets for all partitions of the deck,'' on the
  \SETb game website at
  \url{https://www.setgame.com/sites/default/files/teacherscorner/SETPROOF.pdf},
  accessed \today.

\bibitem{WIKI} Wikipedia article ``Combinatorial Number System,'' \url{https://en.wikipedia.org/wiki/Combinatorial_number_system#Finding_the_k-combination_for_a_given_number},
  accessed \today.

\end{thebibliography}
 
\end{document}
